# Dockeré•œåƒé—®é¢˜è¯Šæ–­å’Œè§£å†³æ–¹æ¡ˆ

## ğŸ“Š è¯Šæ–­ç»“æœ

### æµ‹è¯•ç¯å¢ƒ
- **æœ¬æœº**: Windows Docker Desktop
- **æ•°æ®åº“**: PostgreSQL at 115.190.29.10:5433
- **Redis**: localhost:6379 (æœ¬æœº)

### å‘ç°çš„é—®é¢˜

#### 1. âŒ å¥åº·æ£€æŸ¥è·¯ç”±é…ç½®é”™è¯¯
**é—®é¢˜**: Dockerfileä¸­é…ç½®çš„å¥åº·æ£€æŸ¥ä½¿ç”¨ `/api/health`,ä½†å®é™…è·¯ç”±æ˜¯ `/health`
```dockerfile
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost/api/health || exit 1
```

**å®é™…è·¯ç”±** (backend/app/main.py):
```python
@app.get("/health")  # æ²¡æœ‰ /api å‰ç¼€
async def health_check():
    return {"status": "healthy"}
```

**å½±å“**: å¥åº·æ£€æŸ¥å¤±è´¥,ä½†ä¸å½±å“å®¹å™¨è¿è¡Œ

---

#### 2. âŒ Nginxé…ç½®ç¼ºå°‘å¥åº·æ£€æŸ¥è·¯ç”±ä»£ç†
**é—®é¢˜**: Nginxåªä»£ç† `/api/*` è·¯å¾„,ä½† `/health` ç«¯ç‚¹æ²¡æœ‰è¢«ä»£ç†

**å½“å‰é…ç½®**:
```nginx
location /api {
    proxy_pass http://127.0.0.1:8000;
    ...
}
```

**ç¼ºå°‘**:
```nginx
location /health {
    proxy_pass http://127.0.0.1:8000;
    ...
}
```

**å½±å“**: æ— æ³•é€šè¿‡Nginxè®¿é—®å¥åº·æ£€æŸ¥ç«¯ç‚¹

---

#### 3. âš ï¸ Redisé…ç½®é—®é¢˜ (æœåŠ¡å™¨éƒ¨ç½²å¤±è´¥çš„ä¸»è¦åŸå› )
**é—®é¢˜**: é»˜è®¤é…ç½®ä½¿ç”¨ `redis://localhost:6379/0`

**åœ¨å®¹å™¨å†…**: `localhost` æŒ‡å‘å®¹å™¨æœ¬èº«,è€Œä¸æ˜¯å®¿ä¸»æœº
**åœ¨æœåŠ¡å™¨ä¸Š**: å¦‚æœRedisåœ¨å¤–éƒ¨æœåŠ¡å™¨,å¿…é¡»ä½¿ç”¨å®é™…IPåœ°å€

**è§£å†³**: 
- æœ¬æœºæµ‹è¯•: ä½¿ç”¨ `host.docker.internal` (Windows/Mac)
- æœåŠ¡å™¨éƒ¨ç½²: ä½¿ç”¨å®é™…çš„RedisæœåŠ¡å™¨IPåœ°å€

---

#### 4. âš ï¸ æ•°æ®åº“è¿æ¥é—®é¢˜ (æœåŠ¡å™¨éƒ¨ç½²å¤±è´¥çš„æ¬¡è¦åŸå› )
**é—®é¢˜**: å¦‚æœæ•°æ®åº“åœ¨å¤–éƒ¨æœåŠ¡å™¨,å®¹å™¨å†…æ— æ³•ä½¿ç”¨ `localhost`

**å½“å‰é…ç½®**: `postgresql://flask_user:flask_password@115.190.29.10:5433/ccd_db_new`
**çŠ¶æ€**: âœ… å·²ç»ä½¿ç”¨å®é™…IP,è¿™éƒ¨åˆ†é…ç½®æ­£ç¡®

---

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆæ¦‚è¿°

æˆ‘å°†è¿›è¡Œä»¥ä¸‹ä¿®å¤:

1. **ä¿®å¤å¥åº·æ£€æŸ¥è·¯ç”±** - ç»Ÿä¸€ä½¿ç”¨ `/api/health`
2. **æ›´æ–°Nginxé…ç½®** - æ·»åŠ å¥åº·æ£€æŸ¥è·¯ç”±ä»£ç†
3. **ä¼˜åŒ–ç¯å¢ƒå˜é‡å¤„ç†** - æ”¯æŒå®¹å™¨å†…è®¿é—®å®¿ä¸»æœºæœåŠ¡
4. **æ·»åŠ å¯åŠ¨è„šæœ¬** - è‡ªåŠ¨å¤„ç† `localhost` åˆ° `host.docker.internal` çš„è½¬æ¢
5. **é‡æ–°æ„å»ºå’Œå¯¼å‡ºé•œåƒ** - ç”Ÿæˆä¿®å¤åçš„é•œåƒæ–‡ä»¶

---

## ğŸ“‹ è¯¦ç»†ä¿®å¤æ­¥éª¤

### æ­¥éª¤ 1: ä¿®å¤åç«¯å¥åº·æ£€æŸ¥è·¯ç”±

**æ–‡ä»¶**: `backend/app/main.py`

**ä¿®æ”¹**:
```python
# å°†å¥åº·æ£€æŸ¥è·¯ç”±ç§»åˆ° /api å‰ç¼€ä¸‹
@app.get("/api/health")
async def health_check():
    """å¥åº·æ£€æŸ¥"""
    return {"status": "healthy"}
```

**åŸå› **: ç»Ÿä¸€APIè·¯ç”±è§„èŒƒ,æ‰€æœ‰APIéƒ½åœ¨ `/api` å‰ç¼€ä¸‹

---

### æ­¥éª¤ 2: æ›´æ–°Nginxé…ç½®

**æ–‡ä»¶**: `Dockerfile`

**æ·»åŠ å¥åº·æ£€æŸ¥è·¯ç”±ä»£ç†**:
```nginx
location /api/health {
    proxy_pass http://127.0.0.1:8000/api/health;
    proxy_set_header Host $host;
    access_log off;  # å¥åº·æ£€æŸ¥ä¸è®°å½•æ—¥å¿—
}
```

**åŸå› **: ç¡®ä¿å¥åº·æ£€æŸ¥å¯ä»¥é€šè¿‡Nginxè®¿é—®

---

### æ­¥éª¤ 3: æ·»åŠ å®¹å™¨å¯åŠ¨è„šæœ¬

**æ–‡ä»¶**: æ–°å»º `docker-entrypoint.sh`

**åŠŸèƒ½**:
- è‡ªåŠ¨å°†ç¯å¢ƒå˜é‡ä¸­çš„ `localhost` æ›¿æ¢ä¸º `host.docker.internal` (ä»…Windows/Mac)
- åœ¨LinuxæœåŠ¡å™¨ä¸Šä¿æŒåŸæ ·æˆ–ä½¿ç”¨å®é™…IP
- å¯åŠ¨Supervisor

**åŸå› **: ç®€åŒ–å®¹å™¨é…ç½®,è‡ªåŠ¨å¤„ç†ä¸åŒç¯å¢ƒçš„ç½‘ç»œå·®å¼‚

---

### æ­¥éª¤ 4: æ›´æ–°Dockerfile

**ä¿®æ”¹**:
1. å¤åˆ¶å¯åŠ¨è„šæœ¬
2. è®¾ç½®æ‰§è¡Œæƒé™
3. ä½¿ç”¨å¯åŠ¨è„šæœ¬ä½œä¸ºå…¥å£ç‚¹
4. ä¿®å¤å¥åº·æ£€æŸ¥URL

---

### æ­¥éª¤ 5: é‡æ–°æ„å»ºé•œåƒ

**å‘½ä»¤**:
```bash
docker build -t ccd2-app:latest -f Dockerfile .
```

**é¢„è®¡æ—¶é—´**: 2-5åˆ†é’Ÿ (ä½¿ç”¨ç¼“å­˜)

---

### æ­¥éª¤ 6: å¯¼å‡ºæ–°é•œåƒ

**å‘½ä»¤**:
```bash
docker save -o ccd2-app-fixed.tar ccd2-app:latest
```

**ç”Ÿæˆæ–‡ä»¶**:
- `ccd2-app-fixed.tar` - ä¿®å¤åçš„é•œåƒ
- `ccd2-app-fixed.tar.sha256` - SHA256æ ¡éªŒæ–‡ä»¶

---

## ğŸ¯ ä¿®å¤åçš„ä¼˜åŠ¿

### 1. ç»Ÿä¸€çš„å¥åº·æ£€æŸ¥
- âœ… è·¯ç”±è§„èŒƒ: `/api/health`
- âœ… å¯é€šè¿‡Nginxè®¿é—®
- âœ… Dockerå¥åº·æ£€æŸ¥æ­£å¸¸å·¥ä½œ

### 2. æ›´å¥½çš„ç½‘ç»œå…¼å®¹æ€§
- âœ… æ”¯æŒæœ¬æœºDockeræµ‹è¯• (ä½¿ç”¨host.docker.internal)
- âœ… æ”¯æŒæœåŠ¡å™¨éƒ¨ç½² (ä½¿ç”¨å®é™…IP)
- âœ… è‡ªåŠ¨å¤„ç†ç¯å¢ƒå·®å¼‚

### 3. æ›´æ¸…æ™°çš„é”™è¯¯æç¤º
- âœ… å¯åŠ¨è„šæœ¬ä¼šæ£€æŸ¥å…³é”®ç¯å¢ƒå˜é‡
- âœ… æä¾›æœ‰ç”¨çš„é”™è¯¯ä¿¡æ¯
- âœ… ä¾¿äºæ•…éšœæ’æŸ¥

---

## ğŸ“ æœåŠ¡å™¨éƒ¨ç½²æŒ‡å— (ä¿®å¤å)

### æ­£ç¡®çš„è¿è¡Œå‘½ä»¤

```bash
docker run -d \
  --name ccd2 \
  -p 8080:80 \
  -e DATABASE_URL="postgresql://flask_user:flask_password@115.190.29.10:5433/ccd_db_new" \
  -e REDIS_URL="redis://<RedisæœåŠ¡å™¨IP>:6379/0" \
  -e SECRET_KEY="$(openssl rand -hex 32)" \
  -v $(pwd)/docker-volumes/uploads:/app/uploads \
  -v $(pwd)/docker-volumes/logs:/app/logs \
  --restart unless-stopped \
  ccd2-app:latest
```

### å…³é”®é…ç½®è¯´æ˜

1. **DATABASE_URL**: å·²ç»ä½¿ç”¨å®é™…IP (115.190.29.10:5433) âœ…
2. **REDIS_URL**: éœ€è¦ä½¿ç”¨å®é™…çš„RedisæœåŠ¡å™¨IP
   - å¦‚æœRedisåœ¨åŒä¸€å°æœåŠ¡å™¨: ä½¿ç”¨æœåŠ¡å™¨çš„å†…ç½‘IP
   - å¦‚æœRedisåœ¨å…¶ä»–æœåŠ¡å™¨: ä½¿ç”¨RedisæœåŠ¡å™¨çš„IP
   - âŒ ä¸è¦ä½¿ç”¨ `localhost`

3. **SECRET_KEY**: ä½¿ç”¨éšæœºç”Ÿæˆçš„å¯†é’¥

---

## ğŸ” éªŒè¯æ­¥éª¤

### æœ¬æœºæµ‹è¯•

```bash
# 1. å¯åŠ¨å®¹å™¨
docker run -d --name ccd2-test -p 8080:80 \
  -e DATABASE_URL="postgresql://flask_user:flask_password@115.190.29.10:5433/ccd_db_new" \
  -e REDIS_URL="redis://host.docker.internal:6379/0" \
  -e SECRET_KEY="test-key" \
  ccd2-app:latest

# 2. ç­‰å¾…å¯åŠ¨
sleep 10

# 3. æµ‹è¯•å¥åº·æ£€æŸ¥
curl http://localhost:8080/api/health
# é¢„æœŸè¾“å‡º: {"status":"healthy"}

# 4. æµ‹è¯•å‰ç«¯
curl http://localhost:8080/
# é¢„æœŸè¾“å‡º: HTMLé¡µé¢

# 5. æŸ¥çœ‹æ—¥å¿—
docker logs ccd2-test

# 6. æ¸…ç†
docker stop ccd2-test && docker rm ccd2-test
```

### æœåŠ¡å™¨æµ‹è¯•

```bash
# 1. åŠ è½½é•œåƒ
docker load -i ccd2-app-fixed.tar

# 2. å¯åŠ¨å®¹å™¨ (ä½¿ç”¨å®é™…çš„Redis IP)
docker run -d --name ccd2 -p 8080:80 \
  -e DATABASE_URL="postgresql://flask_user:flask_password@115.190.29.10:5433/ccd_db_new" \
  -e REDIS_URL="redis://192.168.1.100:6379/0" \
  -e SECRET_KEY="your-secret-key" \
  ccd2-app:latest

# 3. ç›‘æ§å¯åŠ¨
docker logs -f ccd2

# 4. éªŒè¯æœåŠ¡
curl http://localhost:8080/api/health
```

---

## ğŸ“Š é¢„æœŸç»“æœ

### ä¿®å¤å‰
- âŒ `/api/health` è¿”å› 404
- âŒ æœåŠ¡å™¨éƒ¨ç½²åç«¯ä¸æ–­é‡å¯
- âŒ å¥åº·æ£€æŸ¥å¤±è´¥

### ä¿®å¤å
- âœ… `/api/health` è¿”å› `{"status":"healthy"}`
- âœ… æœåŠ¡å™¨éƒ¨ç½²ç¨³å®šè¿è¡Œ
- âœ… å¥åº·æ£€æŸ¥é€šè¿‡
- âœ… å‰ç«¯å’Œåç«¯éƒ½å¯æ­£å¸¸è®¿é—®

---

## ğŸš€ æ‰§è¡Œè®¡åˆ’

1. **ä¿®å¤ä»£ç ** (5åˆ†é’Ÿ)
   - ä¿®æ”¹ `backend/app/main.py`
   - åˆ›å»º `docker-entrypoint.sh`
   - æ›´æ–° `Dockerfile`

2. **é‡æ–°æ„å»º** (2-5åˆ†é’Ÿ)
   - æ„å»ºæ–°é•œåƒ
   - æœ¬æœºæµ‹è¯•éªŒè¯

3. **å¯¼å‡ºé•œåƒ** (2-3åˆ†é’Ÿ)
   - å¯¼å‡ºä¸ºtaræ–‡ä»¶
   - ç”ŸæˆSHA256æ ¡éªŒ

4. **æ–‡æ¡£æ›´æ–°** (2åˆ†é’Ÿ)
   - æ›´æ–°ä½¿ç”¨è¯´æ˜
   - æ›´æ–°æ•…éšœæ’æŸ¥æŒ‡å—

**æ€»è®¡æ—¶é—´**: çº¦15-20åˆ†é’Ÿ

---

## âœ… æˆåŠŸæ ‡å‡†

- [ ] æœ¬æœºDockerå®¹å™¨å¯ä»¥æ­£å¸¸è®¿é—® `/api/health`
- [ ] å¥åº·æ£€æŸ¥é€šè¿‡
- [ ] å‰ç«¯é¡µé¢æ­£å¸¸æ˜¾ç¤º
- [ ] åç«¯APIå¯ä»¥æ­£å¸¸è°ƒç”¨
- [ ] é•œåƒæˆåŠŸå¯¼å‡º
- [ ] SHA256æ ¡éªŒæ–‡ä»¶ç”Ÿæˆ
- [ ] æ–‡æ¡£æ›´æ–°å®Œæˆ

---

**å‡†å¤‡å¼€å§‹æ‰§è¡Œ**: ç­‰å¾…ç¡®è®¤åå¼€å§‹ä¿®å¤

