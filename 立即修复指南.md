# 🚨 后端崩溃问题立即修复指南

## 问题现象

您的应用部署到Ubuntu服务器后，后端服务不断重启，日志显示：
```
WARN exited: backend (exit status 3; not expected)
```

## 根本原因

配置文件 `backend/app/config.py` 中硬编码了一个特定的数据库地址，导致即使传入了正确的环境变量，应用仍然尝试连接错误的数据库。

## ✅ 已完成的修复

所有代码已经修复完成！现在您需要：
1. 重新构建Docker镜像
2. 传输到服务器
3. 使用正确的配置运行

---

## 📋 操作步骤

### 步骤1: 在本地重新构建镜像（Windows）

打开PowerShell，在项目目录执行：

```powershell
# 方式A: 使用自动脚本（推荐）
.\rebuild-and-export.ps1

# 方式B: 手动执行
docker build -t ccd2-app:fixed .
docker save ccd2-app:fixed -o ccd2-app-fixed.tar
```

完成后会生成 `ccd2-app-fixed.tar` 或 `ccd2-app-fixed.tar.gz` 文件。

### 步骤2: 传输到Ubuntu服务器

```powershell
# 从Windows传输到Ubuntu服务器
scp ccd2-app-fixed.tar* user@服务器IP:/home/user/
```

### 步骤3: 在Ubuntu服务器上操作

```bash
# 1. SSH登录到服务器
ssh user@服务器IP

# 2. 加载镜像
cd /home/user/
docker load -i ccd2-app-fixed.tar
# 或如果是压缩文件：
# gunzip -c ccd2-app-fixed.tar.gz | docker load

# 3. 停止并删除旧容器
docker stop <旧容器名称>
docker rm <旧容器名称>

# 4. 【重要】配置正确的数据库连接
# 如果数据库在同一服务器，先获取服务器IP：
SERVER_IP=$(hostname -I | awk '{print $1}')
echo "服务器IP: $SERVER_IP"

# 5. 运行新容器（使用正确的数据库地址）
docker run -d \
  --name ccd2-app \
  -p 80:80 \
  -e DATABASE_URL="postgresql://你的用户名:你的密码@${SERVER_IP}:数据库端口/数据库名" \
  -e REDIS_URL="redis://${SERVER_IP}:6379/0" \
  -e SECRET_KEY="$(openssl rand -hex 32)" \
  -v /data/uploads:/app/uploads \
  -v /data/logs:/app/logs \
  ccd2-app:fixed

# 6. 查看日志确认启动
docker logs -f ccd2-app
```

### 步骤4: 验证启动成功

启动日志中应该看到：

```
✅ Database connection: OK
✅ Redis connection: OK
✅ All critical checks passed! Starting application...
```

然后测试API：

```bash
# 测试健康检查
curl http://localhost/api/health
# 应该返回：{"status":"healthy"}

# 或在浏览器访问
http://服务器IP/
```

---

## 🔧 如果数据库在同一服务器上

### 配置PostgreSQL允许Docker连接

```bash
# 1. 编辑PostgreSQL配置
sudo nano /etc/postgresql/15/main/postgresql.conf

# 找到并修改（移除注释）：
listen_addresses = '*'

# 2. 允许Docker网段连接
sudo nano /etc/postgresql/15/main/pg_hba.conf

# 在文件末尾添加：
host    all    all    172.17.0.0/16    md5

# 3. 重启PostgreSQL
sudo systemctl restart postgresql

# 4. 验证PostgreSQL监听
sudo netstat -tlnp | grep 5432
```

---

## ⚠️ 常见错误

### 错误1: DATABASE_URL配置错误

❌ **错误示例：**
```bash
DATABASE_URL="postgresql://user:pass@localhost:5432/db"
```
在Docker容器中，`localhost` 指向容器本身！

✅ **正确示例：**
```bash
# 使用服务器实际IP
DATABASE_URL="postgresql://user:pass@192.168.1.100:5432/db"

# 或使用获取的服务器IP变量
DATABASE_URL="postgresql://user:pass@${SERVER_IP}:5432/db"
```

### 错误2: 数据库连接被拒绝

如果看到 "connection refused"，检查：

```bash
# 1. PostgreSQL是否运行
sudo systemctl status postgresql

# 2. 防火墙是否允许
sudo ufw allow 5432/tcp

# 3. PostgreSQL配置是否正确
cat /etc/postgresql/15/main/pg_hba.conf | grep 172.17
# 应该有：host    all    all    172.17.0.0/16    md5
```

### 错误3: 容器仍然崩溃

```bash
# 查看详细错误
docker logs ccd2-app

# 查看后端错误日志
docker exec ccd2-app cat /var/log/supervisor/backend_err.log

# 运行诊断（如果有诊断脚本）
bash diagnose-docker.sh ccd2-app
```

---

## 🎯 完整运行示例

假设您的配置是：
- 服务器IP: 192.168.1.100
- PostgreSQL端口: 5432
- 数据库名: ccd_db
- 用户名: ccd_user
- 密码: mypassword123

```bash
# 完整命令：
docker run -d \
  --name ccd2-app \
  -p 80:80 \
  -e DATABASE_URL="postgresql://ccd_user:mypassword123@192.168.1.100:5432/ccd_db" \
  -e REDIS_URL="redis://192.168.1.100:6379/0" \
  -e SECRET_KEY="a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6" \
  -v /data/uploads:/app/uploads \
  -v /data/logs:/app/logs \
  ccd2-app:fixed
```

---

## 📊 验证清单

运行以下命令逐项检查：

```bash
# ✓ 1. 容器正在运行（状态为Up）
docker ps | grep ccd2-app

# ✓ 2. 启动日志显示成功
docker logs ccd2-app | grep "✅"

# ✓ 3. 健康检查通过
curl http://localhost/api/health

# ✓ 4. 可以访问Web界面
curl -I http://localhost/

# ✓ 5. 没有不断重启
watch -n 2 'docker ps | grep ccd2-app'
# 观察几秒钟，状态应该保持Up，不会变化
```

---

## 🆘 还是不行？

如果按照步骤操作后仍然有问题，收集以下信息：

```bash
# 生成诊断报告
{
    echo "=== Docker版本 ==="
    docker --version
    echo ""
    echo "=== 容器状态 ==="
    docker ps -a | grep ccd2
    echo ""
    echo "=== 最近50行日志 ==="
    docker logs --tail 50 ccd2-app 2>&1
    echo ""
    echo "=== 环境变量（已隐藏密码）==="
    docker exec ccd2-app env 2>&1 | grep -E 'DATABASE|REDIS' | sed 's/:.*@/:***@/'
    echo ""
    echo "=== PostgreSQL状态 ==="
    sudo systemctl status postgresql
    echo ""
    echo "=== 端口监听 ==="
    sudo netstat -tlnp | grep -E '5432|6379|80'
} > diagnostic.txt 2>&1

cat diagnostic.txt
```

然后查看 `diagnostic.txt` 文件内容。

---

## 📚 详细文档

- `README_DOCKER_FIX.md` - 完整的修复说明
- `DEPLOYMENT_FIX_SUMMARY.md` - 问题分析和解决方案
- `DOCKER_DEPLOYMENT_QUICKSTART.md` - 快速部署指南
- `DOCKER_DEPLOYMENT_FIX.md` - 详细的部署文档

---

## ✨ 成功标志

部署成功后，您应该看到：

1. ✅ 容器状态始终为 `Up`（不重启）
2. ✅ 日志中有 "All critical checks passed!"
3. ✅ 可以访问 http://服务器IP/
4. ✅ API健康检查返回 `{"status":"healthy"}`
5. ✅ 后端日志正常，没有错误

祝部署顺利！🚀

